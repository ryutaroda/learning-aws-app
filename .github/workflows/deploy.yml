name: Deploy to ECS

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'stg'
        type: choice
        options:
          - stg
          - prd

env:
  AWS_REGION: ap-northeast-1

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Mask sensitive information
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          # AWS Account IDをマスク（ECR URIにも含まれるため）
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "::add-mask::$AWS_ACCOUNT_ID"
          # ECR URIのパターンもマスク
          echo "::add-mask::$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"

      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=stg" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Deploy to ECS
        env:
          ENV: ${{ steps.set-env.outputs.environment }}
          CI: true
        run: |
          make deploy-full-with-migrate ENV=${{ steps.set-env.outputs.environment }}

      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Environment: ${{ steps.set-env.outputs.environment }}"
          echo "Commit: ${{ github.sha }}"

