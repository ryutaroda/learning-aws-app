# ALB設定ドキュメント

## 概要

Application Load Balancer (ALB)を作成し、ECSタスクへのトラフィックを分散します。

## 作成順序

### 前提条件

1. ✅ **VPC作成完了**: `learning-stg`
2. ✅ **パブリックサブネット作成完了**: `public-subnet-1a-stg`, `public-subnet-1c-stg`
3. ✅ **セキュリティグループ作成完了**: ALB用とECS用のセキュリティグループ

### 作成手順

#### 1. セキュリティグループのインバウンドルール追加

- [X] **ALB用セキュリティグループのインバウンドルール確認・追加**
  - EC2コンソール → セキュリティグループ → `learning-alb-sg-stg` を選択
  - インバウンドルールを編集
  - 以下のルールが設定されているか確認（なければ追加）:
    - **HTTP (80)**:
      - タイプ: HTTP
      - プロトコル: TCP
      - ポート範囲: 80
      - ソース: 0.0.0.0/0
      - 説明: インターネットからのHTTPアクセス
    - **HTTPS (443)**:
      - タイプ: HTTPS
      - プロトコル: TCP
      - ポート範囲: 443
      - ソース: 0.0.0.0/0
      - 説明: インターネットからのHTTPSアクセス

#### 2. ターゲットグループの作成

- [X] **ターゲットグループ作成**
  - ターゲットタイプ: IPアドレス
  - 名前: `learning-tg-stg`
  - プロトコル: HTTP
  - ポート: 80
  - VPC: `learning-stg`
  - ヘルスチェック:
    - プロトコル: HTTP
    - パス: `/up`（アプリケーションのヘルスチェックエンドポイント）
    - 正常なしきい値: 2
    - 異常なしきい値: 2
    - タイムアウト: 5秒
    - 間隔: 30秒

#### 3. ALBの基本設定

- [X] **ALB作成開始**

  - EC2コンソール → ロードバランサー → ロードバランサーを作成
  - ロードバランサータイプ: Application Load Balancer
  - 名前: `learning-alb-stg`
  - スキーム: インターネット向け
  - IPアドレスタイプ: IPv4
- [X] **ネットワークマッピング**

  - VPC: `learning-stg`
  - アベイラビリティーゾーン:
    - `ap-northeast-1a`: `public-subnet-1a-stg` を選択
    - `ap-northeast-1c`: `public-subnet-1c-stg` を選択
- [X] **セキュリティグループ設定**

  - セキュリティグループ: ALB用のセキュリティグループを選択
  - インバウンドルール:
    - HTTP (80): 0.0.0.0/0
    - HTTPS (443): 0.0.0.0/0

#### 4. リスナーの設定

- [X] **HTTPリスナー（80）の設定**

  - プロトコル: HTTP
  - ポート: 80
  - デフォルトアクション: HTTPSへリダイレクト
    - リダイレクト先: `https://#{host}:443/#{path}?#{query}`
    - ステータスコード: 301
- [X] **HTTPSリスナー（443）の設定**

  - プロトコル: HTTPS
  - ポート: 443
  - デフォルトSSL証明書: ACM証明書を選択（後で設定可能）

  **ルール1: 許可するドメイン（優先度: 100）**

  - 条件:
    - ホストヘッダーが以下のいずれかと一致:
      - `example.com`
      - `www.example.com`
      - （必要に応じて他のサブドメインも追加）
  - アクション:
    - ターゲットグループへ転送: `learning-tg-stg`

  **デフォルトアクション（優先度: 1）**

  - 条件: なし
  - アクション:
    - 固定レスポンスを返す:
      - HTTPレスポンスコード: 403
      - コンテンツタイプ: text/plain
      - レスポンス本文: Forbidden

**注意**: HTTPリスナー（80）を使用する場合、セキュリティグループでポート80へのインバウンドトラフィックを許可する必要があります。許可されていない場合、「Listener port unreachable」エラーが表示されます。

#### 5. ECSサービスへのロードバランサー紐付け

- [X] **ECSサービス設定でロードバランサーを紐付け**
  - ECSコンソール → クラスター → `learning-cluster-stg` → サービス → `learning-ecs-service-stg` を選択
  - 「更新」をクリック
  - 「ロードバランシング」セクションで以下を設定:
    - **ロードバランサータイプ**: Application Load Balancer
    - **コンテナとポート**:
      - コンテナ名: `app`
      - コンテナポート: `80`
      - ホストポート: `80`（Fargateではコンテナポートと同じ）
      - 形式: `app 80:80`（Host port:Container port）
    - **ロードバランサー**: `learning-alb-stg` を選択
      - スキーム: インターネット向け（internet-facing）
    - **リスナー**: `HTTPS:443` を選択
    - **ターゲットグループ**: `learning-tg-stg` を選択
      - ターゲットタイプ: IP
  - 「更新」をクリックしてサービスを更新

**重要**: ECSサービスを更新すると、新しいタスクが起動し、ターゲットグループに自動的に登録されます。ターゲットグループのヘルスチェックが正常になるまで数分かかる場合があります。

## まとめ

### 作成したリソース


| リソース           | 名前             | 用途                      |
| -------------------- | ------------------ | --------------------------- |
| ALB                | learning-alb-stg | トラフィック分散          |
| ターゲットグループ | learning-tg-stg  | ECSタスクへのルーティング |

### 重要なポイント

**セキュリティグループ**:

- ALBのセキュリティグループ: HTTP/HTTPSを許可
- ECSタスクのセキュリティグループ: ALBからのトラフィックを許可

**リスナールール**:

- HTTPSリスナー（443）では、ホストヘッダーで許可するドメインを指定
- 許可されたドメインのみターゲットグループへ転送
- それ以外のリクエストは403 Forbiddenを返す（セキュリティ強化）

**ヘルスチェック**:

- ターゲットグループのヘルスチェックでECSタスクの正常性を監視
- 正常なタスクのみにトラフィックをルーティング

**料金**:

- ALB: $0.0225/時間（約$16.20/月）
- LCU（Load Balancer Capacity Units）: 使用量に応じて課金

### トラブルシューティング

**ターゲットがUnhealthyになる場合**:

1. セキュリティグループでALBからECSタスクへの通信が許可されているか確認
2. ヘルスチェックパスが正しく設定されているか確認
3. ECSタスクが正常に起動しているか確認

**ALBにアクセスできない場合**:

1. セキュリティグループでHTTP/HTTPSが許可されているか確認
2. パブリックサブネットに配置されているか確認
3. インターネットゲートウェイが正しく設定されているか確認
